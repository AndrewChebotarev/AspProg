% Формирование ЛЧМ-сигнала для зондирования ДКМВ-канала в полосе 12 кГц.

% Причины выбора параметров для полосы 12 кГц:
% 1) Ширина полосы ограничена 12 кГц - типичная полоса для КВ-каналов
% 2) Хотим создать сигнал, с помощью которого можно увидеть лучи с разносом до 9 мс,
%    а также Doppler shift/spread от -5 до +5 Гц
% 3) При SAMPLE_RATE 48 кГц мы отфильтруем на приёме 12 кГц (от -6 до +6 кГц)
%    Из-за этого рабочей областью Power_Delay_Profile (p.d.p.) будет четверть выхода ifft
%    При длине ifft 2048 мы получим длительность символа ЛЧМ 42.(6) мс,
%    а также рабочую часть p.d.p. от -5.(3) до +5.(3) мс. Это 512 точек. Это нас устраивает
% 4) Набрав 4096 ЛЧМ-символов ( 3 минуты ), мы сможем сделать fft-4096
%    по оси "медленного" времени, и получить диаграмму "задержка-Допплер"
%    Тогда у нас получится диапазон Допплера от -11.71875 до +11.71875 Гц
%    Это 4096 точек. Это нас устраивает
%
% 11.71875 Гц = 1/2/(42.(6) мс) - максимальный допплеровский сдвиг, который можно обнаружить

% Очистка командного окна MATLAB
clc;
% Очистка рабочей области (удаление всех переменных)
clear;

% Добавление папки 'src' в путь поиска функций MATLAB
addpath('src');

% Установка частоты дискретизации 48 кГц для полосы 12 кГц
% Соотношение частоты дискретизации к полосе сигнала: 48/12 = 4 (коэффициент передискретизации)
SAMPLE_RATE_Hz = 48000;

% Определение длины БПФ для обработки ЛЧМ-сигнала
% fft_loglen = 11 означает, что fft_len = 2^11 = 2048 точек
fft_loglen = 11;
% Длина одного периода ЛЧМ-сигнала в отсчетах
fft_len = 2^fft_loglen;

% Вывод информации о длительности периода ЛЧМ-сигнала
% Расчет: 2048 отсчетов / 48000 Гц * 1000 = 42.667 мс
fprintf('period %5.3f ms (%u samples)\n', fft_len/SAMPLE_RATE_Hz*1000, fft_len);

% Параметры зондирующего ЛЧМ-сигнала:

% Ширина полосы ЛЧМ-сигнала - 12 кГц
chirp_bandwidth_Hz = 12000;
% Коэффициент для обратного chirp - определяет долю времени на обратный ход частоты
reverse_chirp_divider = 32; % доля времени на "обратный" chirp
% Уровень ослабления сигнала в децибелах для предотвращения перегрузки
att_dB = 0.25;

% Перевод ослабления из децибел в линейные единицы (множитель амплитуды)
% Формула: 10^(-att_dB/20) - для перевода дБ амплитуды в линейный коэффициент
att_mul = 10^(-att_dB/20);

% Генерация комплексного ЛЧМ-сигнала (Chirp Spread Spectrum)
% Функция make_css_iq создает ЛЧМ-сигнал с заданными параметрами:
% - chirp_bandwidth_Hz: ширина полосы
% - SAMPLE_RATE_Hz: частота дискретизации  
% - fft_len: длина сигнала
% - fft_len/reverse_chirp_divider: длина обратного chirp-сегмента
% Результат умножается на коэффициент ослабления
mas_CSS_12k_IQ = att_mul * make_css_iq(chirp_bandwidth_Hz, SAMPLE_RATE_Hz, fft_len, fft_len/reverse_chirp_divider);

% Сохранение эталонного ЛЧМ-сигнала в файл формата cfloat32
% Этот файл будет использоваться как эталон для корреляционной обработки на приеме
save_to_cfloat32(mas_CSS_12k_IQ, 'test_iq_etalon/etalon_12kHz');

% Альтернативное сохранение в текстовый формат (закомментировано):
% cfloat32_to_txt(mas_CSS_12k_IQ, 'data_for_cpp_maket/etalon_12kHz');


% Создание передаваемого сигнала путем повторения эталонного ЛЧМ-сигнала
% N_repeats = 10 - количество повторений эталонного сигнала
N_repeats = 10;

% Создание матрицы, где каждый столбец - это эталонный ЛЧМ-сигнал
mas_Tx_12k_IQ = mas_CSS_12k_IQ * ones(1,N_repeats);
% Преобразование матрицы в вектор-столбец (конкатенация всех периодов)
mas_Tx_12k_IQ = mas_Tx_12k_IQ(:);

% Визуализация передаваемого сигнала:
% Построение осциллограммы (временной формы сигнала)
my_oscillogram(mas_Tx_12k_IQ, SAMPLE_RATE_Hz);
% Построение спектра сигнала
my_spectr(mas_Tx_12k_IQ, SAMPLE_RATE_Hz);
% Построение спектрограммы (время-частота-интенсивность)
my_spectrogram_db(mas_Tx_12k_IQ, 1024, SAMPLE_RATE_Hz);

%%

% Сохранение передаваемого сигнала в файл
% Этот файл будет использоваться для передачи через SDR-устройство
save_to_cfloat32(mas_Tx_12k_IQ, 'test_iq_tx/sounding_12kHz');

